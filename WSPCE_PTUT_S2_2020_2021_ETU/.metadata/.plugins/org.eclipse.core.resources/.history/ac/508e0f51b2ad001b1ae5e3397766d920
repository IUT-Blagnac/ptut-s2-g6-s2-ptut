package model.orm;

import model.data.*;
import model.orm.exception.DataAccessException;
import model.orm.exception.DatabaseConnexionException;
import model.orm.exception.Order;
import model.orm.exception.RowNotFoundOrTooManyRowsException;
import model.orm.exception.Table;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;

/**
 * Classe réalisant le lien entre le programme Java et les employés de la base de données Oracle
 */
public class AccessEmploye {
    public AccessEmploye() {
    }

    /**
     * Permet de récupérer un employé depuis la BD via son login et son mdp
     *
     * @param pfLogin login de l'employé
     * @param pfMdp   mdp de l'employé
     * @return un employé
     * @throws DatabaseConnexionException 
     * @throws DataAccessException 
     * @throws RowNotFoundOrTooManyRowsException 
     */
    public Employe getEmployeLogin(String pfLogin, String pfMdp) throws DatabaseConnexionException, DataAccessException, RowNotFoundOrTooManyRowsException {

        Employe employeTrouve;

        try {
            Connection con = LogToDatabase.getConnexion();

            String query = "Select e.* FROM Employe e WHERE login = ? AND motdepasse = ?  ";

            PreparedStatement pst = con.prepareStatement(query);
            pst.setString(1, pfLogin);
            pst.setString(2, pfMdp);
            ResultSet rs = pst.executeQuery();

            //Si trouvé
            if (rs.next()) {
                int idEmploye = rs.getInt(1);
                String nom = rs.getString(2);
                String prenom = rs.getString(3);
                String login = rs.getString(4);
                String mdp = rs.getString(5);
                int estAcif = rs.getInt(6);
                int idRole = rs.getInt(7);
                int idComp = rs.getInt(8);
                int idNiv = rs.getInt(9);

                employeTrouve = new Employe(idEmploye, nom, prenom, login, mdp, estAcif, idRole, idComp, idNiv);
            } else {
                //Si non trouvé
                rs.close();
                pst.close();
                return null;
            }

            //Si on trouve plus d'une personne
            if (rs.next()) {
                rs.close();
                pst.close();
                throw new RowNotFoundOrTooManyRowsException(Table.Employe, Order.SELECT, "Recherche anormale (en trouve au moins 2)", null, 2);
            }

            rs.close();
            pst.close();
            return employeTrouve;
        } catch (SQLException e) {
        	throw new DataAccessException(Table.Employe, Order.SELECT, "Erreur accès", e);
        }
    }
    
    /**
     * Permet de récuperer les employes de la base de données.
     * dont le nom ou le prénom commencent par nomOuPrenom
     * @param	nomOuPrenom	début du nom ou du prénom recherchés
     * @return une ArrayList d' Employe
     * @throws DataAccessException 
     * @throws DatabaseConnexionException 
     * @throws RowNotFoundOrTooManyRowsException 
     * 
     */
    public ArrayList<Employe> getEmployes(String nomOuPrenom) throws DataAccessException, DatabaseConnexionException, RowNotFoundOrTooManyRowsException {
        // Initialisation
        ArrayList<Employe> alEmploye = new ArrayList<>();

        try {
            // Connexion a la base de données
            Connection con = LogToDatabase.getConnexion();
            
            nomOuPrenom = "%"+nomOuPrenom.toUpperCase()+"%";

            // Requete
            String query = "Select e.* "
            		+ " FROM Employe e "
            		+ " WHERE (upper(e.nom) like ? OR upper(e.prenom) like ?)"
            		+ " ORDER BY e.nom";

            PreparedStatement pst = con.prepareStatement(query);
            pst.setString(1, nomOuPrenom);
            pst.setString(2, nomOuPrenom);

            System.err.println(query);
            
            // Exécution de la requete
            ResultSet rs = pst.executeQuery();

            while (rs.next()) {
                // On crée l'employe

            	Employe emp = new Employe(rs.getInt("idemploye"), rs.getString("nom"), rs.getString("prenom"), rs.getString("login"), rs.getString("motdepasse"), rs.getInt("estACtif"), rs.getInt("idRole"), rs.getInt("idCompetence"), rs.getInt("idNiveau"));
                // puis on recupere aussi ses competences et on les ajoute
                // On ajoute l'employe a l'arrayList
                alEmploye.add(emp) ;
            }

            // on ferme la requete
            rs.close();
            pst.close();
            return alEmploye;

        } catch (SQLException e) {
        	throw new DataAccessException(Table.Employe, Order.SELECT, "Erreur accés", e);
        }
    }


    /**
     * Permet d'inserer un employé dans la base de donnée
     * @param pfEmploye Un employé a insérer
     * @throws DataAccessException 
     * @throws DatabaseConnexionException 
     */
    public void insertEmploye(Employe pfEmploye) throws RowNotFoundOrTooManyRowsException, DataAccessException, DatabaseConnexionException {
        try {
            Connection con = LogToDatabase.getConnexion();

            String query = "INSERT INTO EMPLOYE VALUES ("
                    + "seq_id_employe.NEXTVAL"
                    + ", " + "?"
                    + ", " + "?"
                    + ", " + "?"
                    + ", " + "?"
                    + ", " + "?"
                    + ", " + "?"
                    + ", " + "?"
                    + ", " + "?"
                    +")";

            PreparedStatement pst = con.prepareStatement(query);
            pst.setString(1, pfEmploye.getNom());
            pst.setString(2, pfEmploye.getPrenom());
            pst.setString(3, pfEmploye.getLogin());
            pst.setString(4, pfEmploye.getMdp());
            pst.setInt (5, pfEmploye.getEstActif());
            pst.setInt (6, pfEmploye.getIdRole());
            pst.setInt (7, pfEmploye.getIdCompetence());
            pst.setInt (8, pfEmploye.getIdNiveau());

            System.err.println(query);

            int result = pst.executeUpdate();
            pst.close();

            if (result != 1) {
                con.rollback();
                throw new RowNotFoundOrTooManyRowsException(Table.Employe, Order.INSERT, "Insert anormal (insert de moins ou plus d'une ligne)", null, result);
            }
            con.commit();

        } catch (SQLException e) {
        	throw new DataAccessException(Table.Employe, Order.INSERT, "Erreur accés", e);
        }

    }

    /**
     * Permet de mettre à jour les attributs d'un employé passée en paramètre
     * @param pfEmploye un Employe en mettre a jour
     * @throws DataAccessException 
     * @throws DatabaseConnexionException 
     * @throws RowNotFoundOrTooManyRowsException 
     */
    public void updateEmploye(Employe pfEmploye) throws DataAccessException, DatabaseConnexionException, RowNotFoundOrTooManyRowsException{
        try {
            Connection con = LogToDatabase.getConnexion();

            String query = "UPDATE EMPLOYE SET "
                    + "NOM = " + "?" + " , "
                    + "PRENOM = " + "?" + " , "
                    + "LOGIN = " + "?" + " , "
                    + "MOTDEPASSE = " + "?"  + " , "
                    + "ESTACTIF = " + "?"  + " , "
                    + "IDROLE = "  + "?" + " , "
                    + "IDCOMPETENCE = " + "?"  + " , "
                    + "IDNIVEAU = "  + "?"
                    + " " + "WHERE IDEMPLOYE = ? ";

            PreparedStatement pst = con.prepareStatement(query);
            pst.setString(1, pfEmploye.getNom());
            pst.setString(2, pfEmploye.getPrenom()) ;
            pst.setString(3, pfEmploye.getLogin());
            pst.setString(4, pfEmploye.getMdp());
            pst.setInt(5, pfEmploye.getEstActif());
            pst.setInt (6, pfEmploye.getIdRole());
            pst.setInt (7, pfEmploye.getIdCompetence());
            pst.setInt (8, pfEmploye.getIdNiveau());

            pst.setInt (9, pfEmploye.getId());

            System.err.println(query);

            int result = pst.executeUpdate();
            pst.close();

            if (result != 1) {
                con.rollback();
                throw new  RowNotFoundOrTooManyRowsException(Table.Employe, Order.UPDATE, "Update anormal (update de moins ou plus d'une ligne)", null, result);
            }
            con.commit();

        } catch (SQLException e) {
        	throw new DataAccessException(Table.Employe, Order.UPDATE, "Erreur accés", e);
        }


    }

    /**
     * Permet de supprimer un employe dans la base de données à partir de son id
     * @param pfId l'identifiant d'un employe
     * @throws DataAccessException 
     * @throws RowNotFoundOrTooManyRowsException 
     * @throws DatabaseConnexionException 
     */
    public void deleteEmploye(int pfId) throws DataAccessException, RowNotFoundOrTooManyRowsException, DatabaseConnexionException {
        try {
            Connection con = LogToDatabase.getConnexion();

            String query = "DELETE FROM EMPLOYE WHERE idEmploye = ?";

            PreparedStatement pst = con.prepareStatement(query);
            pst.setInt(1, pfId);

            System.err.println(query);

            int result = pst.executeUpdate();
            pst.close();

            if (result != 1) {
                con.rollback();
                throw new  RowNotFoundOrTooManyRowsException(Table.Employe, Order.DELETE, "DELETE anormal (DElETE de moins ou plus d'une ligne)", null, result);
            }
            con.commit();


        } catch (SQLException e) {
        	throw new DataAccessException(Table.Employe, Order.DELETE, "Erreur accés", e);
        }
    }

}

